{% extends "base.html" %}
{% load humanize %}
{% block content %}

<style>
.container, .container-fluid, .content-wrapper {
  padding-left: 3px !important;
  padding-right: 3px !important;
  margin-left: 3px !important;
  margin-right: 3px !important;
}
</style>

<!-- Search / Filter -->
<form method="GET" class="mb-3 d-flex gap-2 align-items-center">
  <input type="text" name="q" value="{{ query }}" class="form-control" placeholder="Search by name, username, or phone">
  
  <select name="due_filter" class="form-select w-auto">
    <option value="">All Due</option>
    <option value="pending" {% if due_filter == 'pending' %}selected{% endif %}>Pending</option>
    <option value="extra" {% if due_filter == 'extra' %}selected{% endif %}>Advance</option>
    <option value="clear" {% if due_filter == 'clear' %}selected{% endif %}>Clear</option>
  </select>

  <input type="hidden" name="show_username" value="{{ show_username }}">
  <button type="submit" class="btn btn-primary">Search</button>
</form>

<!-- Toggle Username -->
<form method="GET" class="mb-3">
  <input type="hidden" name="q" value="{{ query }}">
  <input type="hidden" name="due_filter" value="{{ due_filter }}">
  <input type="hidden" name="show_username" value="{% if show_username == '1' %}0{% else %}1{% endif %}">
  <button type="submit" class="btn btn-outline-secondary btn-sm">
    {% if show_username == '1' %}Show Full Name{% else %}Show Username{% endif %}
  </button>
</form>

<!-- Collapsible Forms -->
<div class="mb-3 d-flex gap-2">
  <button type="button" class="btn btn-success toggle-collapse" data-bs-target="#offlineForm">
    Add Offline Tenant
  </button>
  <button type="button" class="btn btn-success toggle-collapse" data-bs-target="#inviteForm">
    Invite Tenant
  </button>
</div>

<!-- Offline Tenant Form -->
<div class="collapse" id="offlineForm">
  <div class="card card-body mb-3" style="max-width:600px;">
    <form method="POST">
      {% csrf_token %}
      {{ offline_form.non_field_errors }}

      {% for field in offline_form %}
        <div class="mb-3 row align-items-center">
          <label for="{{ field.id_for_label }}" class="col-sm-4 col-form-label">
            {{ field.label }}{% if field.field.required %}<span class="text-danger">*</span>{% endif %}
          </label>
          <div class="col-sm-8">
            {{ field }}
            {{ field.errors }}
          </div>
        </div>
      {% endfor %}

      <div class="text-end">
        <button type="submit" name="add_offline" class="btn btn-success btn-sm">Save</button>
      </div>
    </form>
  </div>
</div>


<!-- Invite Tenant Form -->
<div class="collapse" id="inviteForm">
  <div class="card card-body mb-3" style="max-width:600px;">
    <form method="POST">
      {% csrf_token %}
      {{ invite_form.non_field_errors }}
      {% for field in invite_form %}
        <div class="mb-3 row align-items-center">
          <label for="{{ field.id_for_label }}" class="col-sm-4 col-form-label">
            {{ field.label }}{% if field.field.required %}<span class="text-danger">*</span>{% endif %}
          </label>
          <div class="col-sm-8">
            {{ field }}
            {{ field.errors }}
          </div>
        </div>
      {% endfor %}
      <div class="text-end">
        <button type="submit" name="invite_tenant" class="btn btn-success btn-sm">Send Invite</button>
      </div>
    </form>
  </div>
</div>

<div class="mt-2" style="margin:0; padding:0; width:100%;">
  <div class="table-responsive" style="margin:0; padding:0; width:100%;">
    <table class="table table-bordered table-hover mt-3 w-100" style="font-size: 0.85rem; white-space: nowrap;">
      <thead class="table-light">
      <tr>
        <th>Name / Username</th>
        <th class="d-none d-sm-table-cell">Property Name</th>
        <th class="d-none d-sm-table-cell">Phone No</th>
        <th>Rent</th>
        <th>Due Amount</th>
        <th>Meter Reading</th>
        <th class="d-none d-sm-table-cell">Joined On</th>
        <th>Bill</th>
        <th>Note</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for tenant in tenants %}
      <tr class="{% if tenant.pending_invite %}text-muted fst-italic{% elif tenant.status == 'pending' %}text-muted{% endif %}">
        <!-- Name / Username with colored dot -->
        <td class="p-1">
          <span style="display:inline-block;width:6px;height:6px;border-radius:50%;background-color:{% if tenant.type_label == 'Offline' %}red{% else %}green{% endif %};"></span>
          {% if tenant.is_online and show_username == '1' %}
            {{ tenant.tenant_obj.username }}
          {% else %}
            {{ tenant.name }}
          {% endif %}
        </td>

        <td class="d-none d-sm-table-cell p-1">{{ tenant.property_name|default:"-" }}</td>
        <td class="d-none d-sm-table-cell p-1">{{ tenant.phone_number|default:"-" }}</td>

        <!-- Rent -->
        <td class="p-1">{% if tenant.rent %}₹{{ tenant.rent|intcomma }}{% else %}-{% endif %}</td>

        <!-- Due Amount -->
        <td class="p-1">
          {% if tenant.due_amount is not None %}
            {% if tenant.due_amount < 0 %}
              <span class="badge bg-primary">₹{{ tenant.due_amount }} (Advance)</span>
            {% elif tenant.due_amount == 0 %}
              <span class="badge bg-success">₹0 (Clear)</span>
            {% else %}
              <span class="badge bg-warning text-dark">₹{{ tenant.due_amount }} (Pending)</span>
            {% endif %}
          {% else %}
            <span class="badge bg-secondary">-</span>
          {% endif %}
        </td>

        <!-- Meter Reading -->
        <td class="p-1">{% if tenant.latest_meter %}{{ tenant.latest_meter }}{% else %}{{ tenant.starting_meter_reading|default:0 }}{% endif %}</td>

        <td class="d-none d-sm-table-cell p-1">{{ tenant.start_date|default:"-" }}</td>

        <!-- View Bill -->
        <td class="p-1">
          {% if not tenant.pending_invite %}
            <a href="{% url 'view_bill' tenant.id tenant.type_label %}" class="btn btn-sm btn-outline-primary py-0 px-1">View Bill</a>
          {% else %}
            <span class="text-muted fst-italic">Pending</span>
          {% endif %}
        </td>

        <!-- Note -->
        <td class="p-1">
          {% if tenant.note %}
            <a href="#" class="btn btn-sm btn-outline-info py-0 px-1" data-bs-toggle="modal" data-bs-target="#noteModal{{ tenant.id }}">View / Edit</a>
          {% elif not tenant.pending_invite %}
            <a href="#" class="btn btn-sm btn-outline-secondary py-0 px-1" data-bs-toggle="modal" data-bs-target="#noteModal{{ tenant.id }}">Add Note</a>
          {% else %}
            <span class="text-muted">-</span>
          {% endif %}

          <!-- Note Modal -->
          <div class="modal fade" id="noteModal{{ tenant.id }}" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <form method="POST" action="{% url 'update_tenant_note' tenant.id %}">
                  {% csrf_token %}
                  <div class="modal-header">
                    <h5 class="modal-title">Tenant Note ({{ tenant.name }})</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    <textarea name="note" class="form-control" rows="5">{{ tenant.note }}</textarea>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </td>

        <!-- Actions -->
        <td class="p-1">
          {% if tenant.pending_invite %}
            <span class="fst-italic text-muted">Pending Invite</span>
          {% else %}
            <a href="{% url 'update_tenant' tenant.id %}" class="btn btn-sm btn-warning py-0 px-1">View</a>
            {% if tenant.type_label == 'Offline' %}
              <a href="{% url 'delete_offline_tenant' tenant.id %}" class="btn btn-sm btn-danger py-0 px-1" onclick="return confirm('Are you sure?')">Delete</a>
            {% else %}
              <a href="{% url 'delete_tenant_link' tenant.id %}" class="btn btn-sm btn-danger py-0 px-1" onclick="return confirm('Are you sure?')">Delete</a>
            {% endif %}
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="10" class="text-center p-1">No tenants found</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>




<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.querySelectorAll('.toggle-collapse').forEach(btn => {
  btn.addEventListener('click', function(e) {
    e.preventDefault();
    const target = document.querySelector(btn.getAttribute('data-bs-target'));
    const bsCollapse = bootstrap.Collapse.getOrCreateInstance(target);
    bsCollapse.toggle();
  });
});
</script>
{% endblock %}
